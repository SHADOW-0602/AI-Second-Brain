<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>LivingOS AI - Intelligent Memory System</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="css/os_theme.css?v=2">
    <!-- Marked for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
    <div class="os-container">
        <!-- 1. Navigation Rail -->
        <div class="nav-rail">
            <div class="nav-icon active" title="Memory Workspace">M</div>
            <div class="nav-icon" title="Chat History">C</div>
            <div class="nav-icon" title="Files">F</div>
        </div>

        <!-- 2. Sidebar (File Explorer) -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>LIVINGOS AI</span>
                <button id="new-session-btn"
                    style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:20px;"
                    title="New Chat Session">+</button>
            </div>

            <div class="upload-btn" onclick="document.getElementById('file-upload').click()" ondrop="handleDrop(event)"
                ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <span>Upload Files (Multiple)</span>
                <input type="file" id="file-upload" style="display: none" multiple>
            </div>

            <div class="sidebar-content" id="file-list">
                <!-- File items will be injected here -->
            </div>
        </div>

        <!-- 3. Main Workspace (Document Viewer) -->
        <div class="workspace" id="workspace">
            <div class="workspace-header" style="display: flex; justify-content: flex-end; padding: 10px 40px;">
                <div>
                    <button id="generate-notes-btn" class="action-btn" style="display: none;">Generate Smart
                        Notes</button>
                </div>
            </div>

            <div class="doc-container" id="doc-viewer">
                <!-- Document content will be rendered here -->
                <h1>Welcome to LivingOS AI</h1>
                <p>Your intelligent, evolving memory system.</p>
                <p>Upload documents or create notes on the left. Chat with them on the right.</p>
            </div>

            <div class="doc-container" id="notes-viewer" style="display: none;">
                <!-- Notes content will be rendered here -->
                <div class="notes-header">
                    <h2>Smart Notes</h2>
                    <button id="close-notes-btn"
                        style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Close</button>
                </div>
                <div id="notes-content"></div>
            </div>
        </div>

        <!-- 4. AI Companion (Chat) -->
        <div class="ai-panel">
            <div class="chat-header">
                <div class="status-dot"></div>
                AI Companion
                <span id="typing-indicator"
                    style="font-size: 0.8em; color: var(--text-muted); margin-left: 10px; display: none;">typing...</span>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="message msg-ai">
                    Hello! I'm ready to help. Open a document to give me context, or just start
                    chatting.
                </div>
            </div>

            <div class="chat-input-area">
                <div class="context-badge" id="active-context-badge" style="display: none;">
                    Reading: <span id="active-doc-name">None</span>
                </div>
                <div class="input-wrapper">
                    <textarea class="chat-input" id="chat-input" placeholder="Type a message..." rows="1"></textarea>
                    <button class="send-btn" id="send-btn">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Initialize session ID first
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Use a more persistent session - only generate new if none exists
        // Use sessionStorage - persists on reload/refresh, but clears on new tab/window
        let currentSessionId = sessionStorage.getItem('currentSessionId');
        if (!currentSessionId) {
            currentSessionId = generateSessionId();
            sessionStorage.setItem('currentSessionId', currentSessionId);
        }
        console.log('Session initialized:', currentSessionId);

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = 'var(--accent)';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '';
            const files = e.dataTransfer.files;
            uploadFiles(files);
        }

        async function uploadFiles(files) {
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', currentSessionId);
                console.log('Uploading file with session_id:', currentSessionId);

                try {
                    const response = await fetch('/api/ingest', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Upload successful:', result);

                        if (result.metadata && result.metadata.preview_text) {
                            const docViewer = document.getElementById('doc-viewer');
                            docViewer.innerHTML = `
                                <h1>${file.name}</h1>
                                <div style="color: #888; font-size: 0.9em; margin-bottom: 20px;">
                                    Uploaded: ${new Date().toLocaleString()} | Chunks: ${result.chunks_count} | Size: ${result.total_chars} chars
                                </div>
                                <div>${result.metadata.preview_text.replace(/\n/g, '<br>')}</div>
                            `;
                            document.getElementById('generate-notes-btn').style.display = 'inline-block';
                        }

                        loadMemoryFiles();
                        const defaultFileList = document.getElementById('file-list');
                        if (defaultFileList) {
                            loadMemoryFiles();
                        }
                    } else {
                        console.error('Upload failed:', response.status);
                        alert(`Upload failed for ${file.name}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
        }

        function attachFileUploadListener() {
            const fileUpload = document.getElementById('file-upload');

            if (fileUpload) {
                fileUpload.addEventListener('change', async function (e) {
                    const files = e.target.files;
                    if (files.length === 0) return;

                    uploadFiles(files);
                });
            }
        }

        function createNewSession() {
            // Generate new session ID
            currentSessionId = generateSessionId();
            sessionStorage.setItem('currentSessionId', currentSessionId);

            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';

            // Clear document viewer
            const docViewer = document.getElementById('doc-viewer');
            docViewer.innerHTML = `
                <h1>Welcome to LivingOS AI</h1>
                <p>Your intelligent, evolving memory system.</p>
                <p>Upload documents or create notes on the left. Chat with them on the right.</p>
            `;

            // Hide generate notes button
            document.getElementById('generate-notes-btn').style.display = 'none';

            // Reload memory files for new session
            loadMemoryFiles();

            alert('New chat session created!');
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Initial file upload listener
            attachFileUploadListener();
            // Load uploaded files and check for existing chat history
            setTimeout(async () => {
                loadMemoryFiles();

                // Check if current session has any chat history
                try {
                    const response = await fetch(`/api/chat/history/${currentSessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (!data.history || data.history.length === 0) {
                            // No chat history exists, start fresh session
                            const chatMessages = document.getElementById('chat-messages');
                            chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                        } else {
                            // Load existing chat history
                            loadChatHistory();
                        }
                    } else {
                        // API error, show default message
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                    }
                } catch (error) {
                    console.error('Failed to check chat history:', error);
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                }
            }, 100);

            // New session button functionality
            document.getElementById('new-session-btn').addEventListener('click', createNewSession);

            // Chat functionality
            const sendBtn = document.getElementById('send-btn');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

            if (sendBtn && chatInput) {
                sendBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Add user message
                addMessage(message, 'user');
                chatInput.value = '';

                try {
                    const response = await fetch('/api/chat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            message: message,
                            active_document_filename: activeSourceFilename // Send active doc context
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        addMessage(result.response, 'ai');
                    } else {
                        addMessage('Error: Could not get response', 'ai');
                    }
                } catch (error) {
                    addMessage('Error: ' + error.message, 'ai');
                }
            }



            async function loadChatHistory() {
                try {
                    const response = await fetch(`/api/chat/history/${currentSessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        chatMessages.innerHTML = '';

                        if (data.history && data.history.length > 0) {
                            data.history.forEach(msg => {
                                if (msg.role !== 'system') {
                                    addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                                }
                            });
                        } else {
                            chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                        }
                    } else {
                        chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                    }
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                    chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                }
            }
        });

        // Navigation functionality
        const navIcons = document.querySelectorAll('.nav-icon');
        navIcons.forEach((icon, index) => {
            icon.addEventListener('click', () => {
                // If clicking the same active icon, close it
                if (icon.classList.contains('active')) {
                    navIcons.forEach(i => i.classList.remove('active'));
                    // Show default welcome content
                    const sidebar = document.querySelector('.sidebar');
                    sidebar.innerHTML = `
                        <div class="sidebar-header">
                            <span>LIVINGOS AI</span>
                        </div>
                        <div class="sidebar-content">
                            <div style="padding: 20px; text-align: center; color: #666;">Select a section above</div>
                        </div>
                    `;
                    return;
                }

                navIcons.forEach(i => i.classList.remove('active'));
                icon.classList.add('active');

                const sidebar = document.querySelector('.sidebar');

                if (index === 0) { // M - Memory
                    renderMemorySidebar();
                } else if (index === 1) { // C - Chat
                    sidebar.innerHTML = `
                        <div class="sidebar-header">
                            <span>CHAT HISTORY</span>
                        </div>
                        <div class="sidebar-content" id="chat-sessions-list">
                            <div style="padding: 20px; text-align: center; color: #666;">Loading...</div>
                        </div>
                    `;
                    loadChatSessions();
                } else if (index === 2) { // F - Files
                    sidebar.innerHTML = `
                        <div class="sidebar-header">
                            <span>FILES</span>
                        </div>
                        <div class="sidebar-content" id="files-content">
                            <div style="padding: 10px; font-weight: bold; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                                <span>Smart Notes</span>
                                <button onclick="generateSessionSummary()" style="background: var(--accent); border: none; border-radius: 4px; padding: 2px 6px; color: white; cursor: pointer; font-size: 0.8em;" title="Generate summary of all files">Summary</button>
                            </div>
                            <div id="smart-notes-list" style="margin-bottom: 20px;"></div>
                        </div>
                    `;
                    loadSmartNotes();
                }
            });
        });

        async function loadSmartNotes() {
            try {
                const response = await fetch(`/api/notes/list?session_id=${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    const notesList = document.getElementById('smart-notes-list');
                    if (notesList) {
                        if (data.notes && data.notes.length > 0) {
                            notesList.innerHTML = data.notes.map(note => `
                                <div class="file-item" style="justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;" onclick="viewNote('${note.id}')">
                                        <span>[NOTE]</span> ${note.title || 'Untitled Note'}
                                    </div>
                                    <button onclick="deleteNote('${note.id}')" 
                                            style="background: #ff4444; border: none; border-radius: 4px; padding: 4px 8px; color: white; cursor: pointer; font-size: 0.8em;"
                                            title="Delete note">Delete</button>
                                </div>
                            `).join('');
                        } else {
                            notesList.innerHTML = '<div style="padding: 10px; color: #666; font-size: 0.9em;">No smart notes yet</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load smart notes:', error);
            }
        }

        async function generateSessionSummary() {
            if (!confirm('Generate a summary of all files in this session?')) return;

            try {
                const response = await fetch('/api/notes/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: "", // Empty text triggers session summary mode in backend if source_filename is null
                        filename: `session_summary_${Date.now()}.md`,
                        source_filename: null,
                        session_id: currentSessionId
                    })
                });

                if (response.ok) {
                    alert('Session summary generated successfully!');
                    loadSmartNotes();
                } else {
                    alert('Failed to generate summary');
                }
            } catch (error) {
                alert('Error generating summary: ' + error.message);
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;

            try {
                const response = await fetch(`/api/notes/${noteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadSmartNotes();
                } else {
                    alert('Failed to delete note');
                }
            } catch (error) {
                alert('Error deleting note: ' + error.message);
            }
        }

        function viewNote(noteId) {
            // Load and display the note content
            fetch(`/api/notes/${noteId}`)
                .then(response => response.json())
                .then(data => {
                    const docViewer = document.getElementById('doc-viewer');
                    if (docViewer) {
                        // Convert markdown to HTML if needed
                        let content = data.content || '';
                        if (typeof marked !== 'undefined') {
                            content = marked.parse(content);
                        }

                        docViewer.innerHTML = `
                            <div class="note-header" style="border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 25px;">
                                <h1 style="color: var(--accent); margin: 0; font-size: 1.8em;">üìù ${data.title || 'Smart Note'}</h1>
                                <div style="color: var(--text-muted); font-size: 0.9em; margin-top: 8px; display: flex; gap: 20px;">
                                    <span>üìÖ Generated: ${new Date(data.created_at * 1000).toLocaleString()}</span>
                                    ${data.source_file ? `<span>üìÑ Source: ${data.source_file}</span>` : ''}
                                </div>
                            </div>
                            <div class="note-content" style="line-height: 1.7; font-size: 1.05em;">${content}</div>
                        `;

                        // Apply syntax highlighting if available
                        if (typeof hljs !== 'undefined') {
                            docViewer.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        }
                    }
                })
                .catch(error => console.error('Failed to load note:', error));
        }

        async function loadChatSessions() {
            try {
                const response = await fetch('/api/chat/sessions');
                if (response.ok) {
                    const data = await response.json();
                    const sessionsList = document.getElementById('chat-sessions-list');
                    if (sessionsList) {
                        if (data.sessions && data.sessions.length > 0) {
                            // Use default titles instead of loading each one
                            const sessionsWithTitles = data.sessions.map(session => ({
                                ...session,
                                actualTitle: session.title || `Chat ${session.id.substring(0, 8)}`
                            }));

                            sessionsList.innerHTML = sessionsWithTitles.map(session => `
                                <div class="file-item" style="justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;" onclick="loadSession('${session.id}')">
                                        <span>[CHAT]</span> ${session.actualTitle || session.title}
                                        <div style="font-size: 0.8em; color: #666; margin-top: 4px;">${new Date(session.created).toLocaleDateString()}</div>
                                    </div>
                                    <button onclick="deleteChatHistory('${session.id}')" 
                                            style="background: #ff4444; border: none; border-radius: 4px; padding: 4px 8px; color: white; cursor: pointer; font-size: 0.8em;"
                                            title="Delete chat history">Delete</button>
                                </div>
                            `).join('');
                        } else {
                            sessionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No chat sessions yet</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load chat sessions:', error);
                const sessionsList = document.getElementById('chat-sessions-list');
                if (sessionsList) {
                    sessionsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Error loading sessions</div>';
                }
            }
        }



        function addMessage(text, type) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message msg-${type === 'user' ? 'user' : 'ai'}`;

            if (type === 'ai' && typeof marked !== 'undefined') {
                // Render markdown for AI responses
                messageDiv.innerHTML = marked.parse(text);
                // Highlight code blocks if available
                if (typeof hljs !== 'undefined') {
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
            } else {
                messageDiv.textContent = text;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadSession(sessionId) {
            // Update current session and reload history
            currentSessionId = sessionId;
            sessionStorage.setItem('currentSessionId', sessionId);
            loadChatHistoryForSession(sessionId);

            // Switch to Memory view and load documents for this session
            const navIcons = document.querySelectorAll('.nav-icon');
            navIcons.forEach(i => i.classList.remove('active'));
            navIcons[0].classList.add('active'); // Activate Memory (M)

            // Update sidebar to Memory view using the shared function
            renderMemorySidebar(true); // Enable auto-preview
        }

        function renderMemorySidebar(autoPreview = false) {
            const sidebar = document.querySelector('.sidebar');
            sidebar.innerHTML = `
        <div class="sidebar-header">
            <span>LIVINGOS AI</span>
            <button id="new-session-btn-memory" onclick="createNewSession()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:20px;" title="New Chat Session">+</button>
        </div>
        <div class="upload-btn" onclick="document.getElementById('file-upload').click()" 
             ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <span>Upload Files (Multiple)</span>
            <input type="file" id="file-upload" style="display: none" multiple>
        </div>
        <div class="sidebar-content" id="memory-files-list">
            <!-- Uploaded files will appear here -->
        </div>
    `;

            // Re-attach file upload listener
            attachFileUploadListener();
            // Load uploaded files in memory view
            loadMemoryFiles(autoPreview);
        }

        async function loadChatHistoryForSession(sessionId) {
            try {
                const response = await fetch(`/api/chat/history/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '';

                    if (data.history && data.history.length > 0) {
                        data.history.forEach(msg => {
                            if (msg.role !== 'system') {
                                addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                            }
                        });
                    } else {
                        chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                    }
                }
            } catch (error) {
                console.error('Failed to load chat history:', error);
            }
        }

        async function loadMemoryFiles(autoPreview = false) {
            try {
                console.log('Loading memory files for session:', currentSessionId);
                const filesList = document.getElementById('memory-files-list') || document.getElementById('file-list');

                if (filesList) {
                    filesList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Loading files...</div>';
                }

                const response = await fetch(`/api/system/files?session_id=${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Files data received:', data);

                    // Auto-preview first file if requested
                    if (autoPreview && data.files && data.files.length > 0) {
                        console.log('Auto-previewing first file:', data.files[0].filename);
                        viewUploadedFile(data.files[0].filename);
                    }

                    if (filesList) {
                        if (data.files && data.files.length > 0) {
                            console.log('Displaying', data.files.length, 'files');
                            const filesHtml = data.files.map(file => `
                                <div class="file-item" style="justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1;" onclick="viewUploadedFile('${file.filename}')">
                                        <span>[FILE]</span> ${file.filename} ${file.excluded ? '(EXCLUDED)' : ''}
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button onclick="toggleFileExclusion('${file.filename}', ${!file.excluded})" 
                                                style="background: ${file.excluded ? '#4CAF50' : '#ff9800'}; border: none; border-radius: 4px; padding: 4px 8px; color: white; cursor: pointer; font-size: 0.8em;"
                                                title="${file.excluded ? 'Include in AI' : 'Exclude from AI'}">${file.excluded ? 'Include' : 'Exclude'}</button>
                                        <button onclick="deleteFile('${file.filename}')" 
                                                style="background: #ff4444; border: none; border-radius: 4px; padding: 4px 8px; color: white; cursor: pointer; font-size: 0.8em;"
                                                title="Delete file">Delete</button>
                                    </div>
                                </div>
                            `).join('');
                            filesList.innerHTML = filesHtml;
                        } else {
                            console.log('No files found for session:', currentSessionId);
                            filesList.innerHTML = `<div style="padding: 10px; color: #666; font-size: 0.9em;">No files uploaded for this session (${currentSessionId})</div>`;
                        }
                    }
                } else {
                    console.error('Failed to load files:', response.status);
                    if (filesList) {
                        filesList.innerHTML = '<div style="padding: 10px; color: #ff4444; font-size: 0.9em;">Error loading files</div>';
                    }
                }
            } catch (error) {
                console.error('Failed to load memory files:', error);
                const filesList = document.getElementById('memory-files-list') || document.getElementById('file-list');
                if (filesList) {
                    filesList.innerHTML = `<div style="padding: 10px; color: #ff4444; font-size: 0.9em;">Error: ${error.message}</div>`;
                }
            }
        }

        async function deleteFile(filename) {
            if (!confirm(`Delete ${filename}? This will remove it from both storage and search.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/system/files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Delete successful:', result);
                    // Reload the files list
                    loadUploadedFiles();
                } else {
                    console.error('Delete failed:', response.status);
                    alert('Failed to delete file');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting file: ' + error.message);
            }
        }

        // Generate smart notes functionality
        document.getElementById('generate-notes-btn').addEventListener('click', generateSmartNotes);

        let activeSourceFilename = null;

        async function generateSmartNotes() {
            const docViewer = document.getElementById('doc-viewer');
            // Only use visible text if we don't have an active file (fallback)
            const visibleText = docViewer.textContent || docViewer.innerText;

            if (!activeSourceFilename && (!visibleText || visibleText.length < 50)) {
                alert('Please open a document first to generate smart notes');
                return;
            }

            // If we have an active file, don't send the preview text (which might be just metadata)
            // Send empty text so backend fetches full content from Qdrant
            const textToSend = activeSourceFilename ? "" : visibleText.substring(0, 5000);

            try {
                const response = await fetch('/api/notes/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToSend,
                        filename: `smart_note_${Date.now()}.md`,
                        source_filename: activeSourceFilename, // Pass source filename
                        session_id: currentSessionId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('Smart notes generated successfully!');
                    // Refresh smart notes list if in Files view
                    loadSmartNotes();
                } else {
                    alert('Failed to generate smart notes');
                }
            } catch (error) {
                alert('Error generating smart notes: ' + error.message);
            }
        }

        // Close button handlers
        document.getElementById('close-notes-btn').addEventListener('click', function () {
            document.getElementById('notes-viewer').style.display = 'none';
            document.getElementById('doc-viewer').style.display = 'block';
        });

        async function viewUploadedFile(filename) {
            activeSourceFilename = filename; // Track active file
            try {
                const docViewer = document.getElementById('doc-viewer');
                docViewer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Loading preview...</div>';

                // Get file URL
                const urlResponse = await fetch(`/api/system/files/${encodeURIComponent(filename)}/url`);
                let fileUrl = null;
                if (urlResponse.ok) {
                    const urlData = await urlResponse.json();
                    fileUrl = urlData.url;
                }

                const response = await fetch(`/api/system/files?session_id=${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    const file = data.files.find(f => f.filename === filename);

                    if (file) {
                        let previewContent = '';
                        const ext = filename.split('.').pop().toLowerCase();

                        if (fileUrl) {
                            if (ext === 'pdf') {
                                previewContent = `<iframe src="${fileUrl}" style="width: 100%; height: 600px; border: none; border-radius: 8px;"></iframe>`;
                            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                                previewContent = `<img src="${fileUrl}" style="max-width: 100%; border-radius: 8px;">`;
                            } else if (['txt', 'md', 'py', 'js', 'html', 'css', 'json', 'xml', 'csv'].includes(ext)) {
                                // Fetch text content
                                try {
                                    const textResponse = await fetch(fileUrl);
                                    const text = await textResponse.text();
                                    previewContent = `<pre style="background: #1e1e1e; padding: 15px; border-radius: 8px; overflow-x: auto;"><code class="language-${ext}">${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`;
                                    // Highlight if available
                                    if (typeof hljs !== 'undefined') {
                                        setTimeout(() => {
                                            docViewer.querySelectorAll('pre code').forEach((block) => {
                                                hljs.highlightElement(block);
                                            });
                                        }, 100);
                                    }
                                } catch (e) {
                                    previewContent = `<div style="padding: 20px; color: #ff4444;">Failed to load text content: ${e.message}</div>`;
                                }
                            } else {
                                previewContent = `
                                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <p>Preview not available for this file type.</p>
                                        <a href="${fileUrl}" target="_blank" style="color: var(--accent); text-decoration: none;">Download File</a>
                                    </div>
                                `;
                            }
                        } else {
                            previewContent = `<div style="padding: 20px; color: #ff4444;">File URL not available.</div>`;
                        }

                        docViewer.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h1 style="margin: 0; font-size: 1.5em;">${filename}</h1>
                                    <div style="color: #888; font-size: 0.8em; margin-top: 5px;">
                                        ${file.file_type} | ${file.chunks} chunks | ${(file.file_size / 1024).toFixed(1)} KB
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    ${fileUrl ? `<a href="${fileUrl}" target="_blank" style="background: var(--bg-secondary); color: var(--text); padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.9em;">Download</a>` : ''}
                                </div>
                            </div>
                            <div class="preview-container">
                                ${previewContent}
                            </div>
                        `;

                        // Show generate notes button
                        document.getElementById('generate-notes-btn').style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error viewing file:', error);
                document.getElementById('doc-viewer').innerHTML = `<div style="padding: 20px; color: #ff4444;">Error loading file: ${error.message}</div>`;
            }
        }

        async function toggleFileExclusion(filename, exclude) {
            try {
                const response = await fetch(`/api/system/files/${encodeURIComponent(filename)}/exclude?exclude=${exclude}`, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Toggle successful:', result);
                    loadMemoryFiles();
                } else {
                    console.error('Toggle failed:', response.status);
                    alert('Failed to toggle file exclusion');
                }
            } catch (error) {
                console.error('Toggle error:', error);
                alert('Error toggling file exclusion: ' + error.message);
            }
        }

        async function deleteChatHistory(sessionId) {
            if (!confirm('Delete this chat history? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/chat/history/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Chat history deleted:', result);
                    // Reload the chat sessions list
                    loadChatSessions();
                    // Clear current chat if it's the deleted session
                    if (currentSessionId === sessionId) {
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.innerHTML = '<div class="message msg-ai">Hello! I\'m ready to help. Upload documents and ask questions.</div>';
                    }
                } else {
                    console.error('Delete failed:', response.status);
                    alert('Failed to delete chat history');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting chat history: ' + error.message);
            }
        }


    </script>
</body>

</html>